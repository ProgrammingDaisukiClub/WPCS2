box: ruby:2.4.0

services:
  - postgres

build:
  steps:
    - bigtruedata/install-node:
      version: 7.6.0

    - script:
      name: Install dependencies
      code: |
        sudo apt-get update
        sudo apt-get install -y graphviz
        gem update --system

    - npm-install

    - bundle-install

    - rails-database-yml:
      service: postgresql-docker

    - script:
      name: echo ruby information
      code: |
        echo "ruby version $(ruby --version) running"
        echo "from location $(which ruby)"
        echo -p "gem list: $(gem list)"

    - script:
      name: Run lint tools
      code: |
        bundle exec rubocop
        npm run lint

    - script:
      name: Set up db
      code: RAILS_ENV=test bundle exec rake db:schema:load

    - script:
      name: Run minitest
      code: bundle exec rake test

    - script:
      name: Run RSpec
      code: bundle exec rspec

    - script:
      name: Generate erd
      code: |
        RAILS_ENV=test bundle exec rake erd
        mv erd.pdf ${WERCKER_OUTPUT_DIR}

  after-steps:
    - sherzberg/slack-notify:
      subdomain: contestholics
      token: $SLACK_TOKEN
      channel: "#develop"
      username: wercker
      icon_url: https://avatars3.githubusercontent.com/u/1695193?s=140

